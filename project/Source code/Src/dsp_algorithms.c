/*
 * dsp_algorithms.c
 *
 *  Created on: Dec 19, 2018
 *      Author: robert
 */

#include "dsp_algorithms.h"
#define BUFFSIZE 305
#define XCORRSIZE ((BUFFSIZE * 2) -1)


//uint8_t s1[BUFFSIZE] = {1, 2, 2, 1, 5, 6, 2, 1, 2, 11};
//uint8_t s2[BUFFSIZE] = {1, 2, 2, 1, 5, 6, 2, 1, 2, 11};

//uint8_t s1[BUFFSIZE] = {1, 5, 2};
//uint8_t s2[BUFFSIZE] = {2, 1, 5};
uint32_t xcorr[XCORRSIZE];



uint8_t s1[BUFFSIZE] = {0,0,0,0,0,0,0,0,0, 0,
		0, 0, 0, 128,130,133,136,138,141,143,146,
		149,151,154,157,159,162,164,167,
		169,172,174,177,179,182,184,187,
		189,191,194,196,198,200,202,205,
		207,209,211,213,215,217,219,220,
		222,224,226,227,229,231,232,234,
		235,237,238,239,240,242,243,244,
		245,246,247,248,249,250,250,251,
		252,252,253,253,254,254,254,255,
		255,255,255,255,255,255,255,255,
		254,254,254,253,253,252,252,251,
		250,250,249,248,247,246,245,244,
		243,242,240,239,238,237,235,234,
		232,231,229,227,226,224,222,220,
		219,217,215,213,211,209,207,205,
		202,200,198,196,194,191,189,187,
		184,182,179,177,174,172,169,167,
		164,162,159,157,154,151,149,146,
		143,141,138,136,133,130,128,125,
		122,119,117,114,112,109,106,104,
		101,98,96,93,91,88,86,83,
		81,78,76,73,71,68,66,64,
		61,59,57,55,53,50,48,46,
		44,42,40,38,36,35,33,31,
		29,28,26,24,23,21,20,18,
		17,16,15,13,12,11,10,9,
		8,7,6,5,5,4,3,3,
		2,2,1,1,1,0,0,0,
		0,0,0,0,0,0,1,1,
		1,2,2,3,3,4,5,5,
		6,7,8,9,10,11,12,13,
		15,16,17,18,20,21,23,24,
		26,28,29,31,33,35,36,38,
		40,42,44,46,48,50,53,55,
		57,59,61,64,66,68,71,73,
		76,78,81,83,86,88,91,93,
		};


uint8_t s2[BUFFSIZE] = {128,130,133,136,138,141,143,146,
		149,151,154,157,159,162,164,167,
		169,172,174,177,179,182,184,187,
		189,191,194,196,198,200,202,205,
		207,209,211,213,215,217,219,220,
		222,224,226,227,229,231,232,234,
		235,237,238,239,240,242,243,244,
		245,246,247,248,249,250,250,251,
		252,252,253,253,254,254,254,255,
		255,255,255,255,255,255,255,255,
		254,254,254,253,253,252,252,251,
		250,250,249,248,247,246,245,244,
		243,242,240,239,238,237,235,234,
		232,231,229,227,226,224,222,220,
		219,217,215,213,211,209,207,205,
		202,200,198,196,194,191,189,187,
		184,182,179,177,174,172,169,167,
		164,162,159,157,154,151,149,146,
		143,141,138,136,133,130,128,125,
		122,119,117,114,112,109,106,104,
		101,98,96,93,91,88,86,83,
		81,78,76,73,71,68,66,64,
		61,59,57,55,53,50,48,46,
		44,42,40,38,36,35,33,31,
		29,28,26,24,23,21,20,18,
		17,16,15,13,12,11,10,9,
		8,7,6,5,5,4,3,3,
		2,2,1,1,1,0,0,0,
		0,0,0,0,0,0,1,1,
		1,2,2,3,3,4,5,5,
		6,7,8,9,10,11,12,13,
		15,16,17,18,20,21,23,24,
		26,28,29,31,33,35,36,38,
		40,42,44,46,48,50,53,55,
		57,59,61,64,66,68,71,73,
		76,78,81,83,86,88,91,93,
		96,98,101,104,106,109,112,114,
		117,119,122,125,128};


uint16_t cross_correlate_test()
{
	uint32_t largestCorrelation = 0;
	uint16_t sampleNumber = 0;
	uint32_t sum = 0;

	int i;
	int j;

		for(i = 0; i < BUFFSIZE; i++)
		{
			for(j = 0; j < BUFFSIZE -i; j++)
			{
				sum+= s1[j + i] * s2[j];
			}
			if(sum > largestCorrelation)
			{
				largestCorrelation = sum;
				sampleNumber = i;
			}
			sum = 0;
			for(j = 0; j < BUFFSIZE -i; j++)
			{
				sum+= s1[j] * s2[j + i];
			}
			if(sum > largestCorrelation)
			{
				largestCorrelation = sum;
				sampleNumber = i + BUFFSIZE/2;
			}
			sum = 0;
		}

	return sampleNumber;
}

float calculate_angle(uint16_t sample_number)
{
	float angle = 0;
	float timeDelay = (float)sample_number/SAMPLEFREQ;

	angle = acos((SOUNDSPEED*timeDelay)/MIC_DISTANCE);
	return angle;

}
